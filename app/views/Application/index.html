#{extends 'main.html' /}
#{set title:'Home' /}

#{if flash.success}
<p>${flash.success}</p>
#{/if}

#{if flash.error}
<p>${flash.error}</p>
#{/if}

Vous pouvez configurer ce calendrier en cliquant ici : <a href="" onclick="changesettings();return false;">Configuration</a>
<br/><br/>
<style type="text/css">
    #calendar tr td{
        border:1px #e5e5e5 solid;
        padding-left: 10px;
        padding-right: 10px;
        text-align: center;
    }

    #calendar{
        border-collapse: collapse;
        color: #000000;

    }

    .title{
        color:#FFFFFF;
        background:#2e2e2e;
    }

    .title td{
        font-weight:bold;
    }

    .tr_odd{
        background-color: #ccc;
    }

    .tr_even{
        background-color: #eee;
    }

    .today{
        font-weight: bold;

    }
</style>

#{if calItems.size() > 0}
<table id="calendar" cellpadding="5" cellspacing="0">
    <tr>
        <td colspan="8" style="border: 0px black solid;">
            ${adr.raw()}<br/>
            <a href="@{Application.index(monthNumber,-1)}">&lt;</a>
            &nbsp;${month.capFirst()} - ${year}&nbsp;
            <a href="@{Application.index(monthNumber,1)}">&gt;</a><br/>
            <a href="#" onclick="$('#newsletter').slideToggle('slow');">Etre prévenu des événements par mail</a>
            <div id="newsletter" style="display: none">
                <form action="@{Newsletters.subscription()}" method="post">
                    <p class="field">
                        <label>Votre email : </label>
                        <input type="text" name="email"/>
                    </p>
                    <p class="field">
                        <label>Recevoir l'événement : </label>
                        <select name="beforeDay">
                            <option value="0">le jour même</option>
                            <option value="1">1 jour à l'avance</option>
                            <option value="2">2 jours à l'avance</option>
                            <option value="3">3 jours à l'avance</option>
                            <option value="7">1 semaine à l'avance</option>
                        </select>
                    </p>
                    <input type="submit" name="save" value="Sauvegarder"/>

                </form>
            </div>
            <br/><br/>
        </td>
    </tr>
    <tr class="title">
        <td  colspan="2">
            ${month.capFirst()}
        </td>
        <td style="width:70px" >
            Fajr
        </td>
        <td  >
            L. de soleil
        </td>
        <td style="width:70px" >
            Dhuhr
        </td>
        <td  >
            Maghrib
        </td>
        <td  >
            Minuit
        </td>
        <td  >
            Hégirien
        </td>
    </tr>
    #{list items:calItems,as:'c'}
    #{if c.event}
    <tr class="event">
        #{/if}
        #{elseif c_index == today && currentMonth == monthNumber}
    <tr class="today">
        #{/elseif}
        #{else}
    <tr class="tr_${c_parity}">

        #{/else}
        <td style="text-align: left" ${c.event == null?"":"rowspan='2'"}>
            ${c.weekDay.capFirst()}
    </td>
    <td ${c.event == null?"":"rowspan='2'"}>
        ${c_index}
</td>
<td>
    ${c.fajr}
</td>
<td>
    ${c.sunrise}
</td>
<td>
    ${c.duhr}
</td>
<td>
    ${c.maghrib}
</td>
<td>
    ${c.midnight}
</td>
<td ${c.event == null?"":"rowspan='2'"}>
    ${c.hijriDay}
    #{if c.hijriDay == 1 || c_isFirst || c_isLast}
    &nbsp;-&nbsp;${c.hijriMonth}
    #{/if}

</td>

</tr>
#{if c.event}
<tr class="eventName">
    <td colspan="5">
        ${c.event.name}
    </td>
</tr>
#{/if}
#{/list}
<tr class="title">
    <td  colspan="2">
        ${month.capFirst()}
    </td>
    <td style="width:70px" >
        Fajr
    </td>
    <td  >
        L. de soleil
    </td>
    <td style="width:70px" >
        Dhuhr
    </td>
    <td  >
        Maghrib
    </td>
    <td  >
        Minuit
    </td>
    <td  >
        Hégirien
    </td>
</tr>
</table>
#{/if}
#{else}
Vous devez d'abord configurer le calendrier. <br/><br/>
Nous avons détecté les paramètres suivants pour vous : <br/><br/>
<strong>Pays/Ville : </strong><span id="country"></span>/<span id="city"></span> <br/>
<strong>Fuseau horaire : </strong>GMT<span id="gmt"></span><br/>
<strong>Heure de ce fuseau : </strong><span id="hour"></span><br/>
<a href="" onclick="configure();">Cliquez ici pour configurer le calendrier selon ces paramètres</a>


<script type="text/javascript">
    // Build the URL to query...notice the php ip address at the end.
    var url = "http://ipinfodb.com/ip_query2.php?output=json&callback=?&timezone=true";
    var city;
    var country;
    var lat;
    var lng;
    var gmtValue;

    // Utilize the JQuery's JSON function
    $.getJSON(url, function(data){

        //Make sure it processed it okay.
        if(data.Locations[0].Status == "OK"){

            //Parse the JSON
            var location = data.Locations[0];
            city = location.City;
            country = location.CountryName;
            lat = location.Latitude;
            lng = location.Longitude;
            var gmt = gmtSgn(parseInt(location.Gmtoffset/60));
            gmtValue = location.Gmtoffset/60;

            var timezone = location.TimezoneName;
            $.getJSON("http://json-time.appspot.com/time.json?tz="+timezone+"&callback=?",
            function(data){
                $('#hour').html(data.hour+":"+(data.minute < 10?"0"+data.minute:data.minute));
            })


            $('#country').html(country);
            $('#city').html(city);
            $('#gmt').html(gmt);

        }

    });

    function gmtSgn(gmt_){
        var g_sgn="";
        if(gmt_>0)
            g_sgn="+";
        if(gmt_<0)
            g_sgn="-";

        gmt_m=Math.abs(gmt_)%60;
        if(gmt_>0)
            gmt_h=Math.abs((gmt_-gmt_m)/60);
        else
            gmt_h=Math.abs((gmt_+gmt_m)/60);

        if(gmt_h<10)
            g_sgn=g_sgn+"0"+gmt_h;
        else
            g_sgn=g_sgn+gmt_h;
        if(gmt_m<10)
            g_sgn=g_sgn+":"+"0"+gmt_m;
        else
            g_sgn=g_sgn+":"+gmt_m;

        return g_sgn;
    }

    function configure(){
        $.cookie("latitude", lat, { expires: 365 });
        $.cookie("longitude", lng, { expires: 365 });
        $.cookie("address", country+", "+city, { expires: 365 });
        $.cookie("timeZone", gmtValue, { expires: 365 });
        
    }
</script>
#{/else}